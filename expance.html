<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expanse Tracker | Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #cat-list::-webkit-scrollbar { width: 4px; }
        #cat-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .filter-active { border: 2px solid #3b82f6 !important; }
    </style>
</head>
<a href="https://pankajoffice5-ctrl.github.io/finance/">üè† Back</a>
<body class="bg-slate-50 min-h-screen font-sans">

    <div id="app-content" class="max-w-md mx-auto pb-20">
        <header class="bg-white border-b p-6 sticky top-0 z-10 flex justify-between items-center shadow-sm">
            <div>
                <h1 class="text-xl font-black text-blue-600">Expanse Trac</h1>
            </div>
            <div class="text-right">
                <p class="text-[10px] font-bold text-slate-400 uppercase">Lifetime Spend</p>
                <h2 id="total-amount" class="text-xl font-black text-slate-800">0.00</h2>
            </div>
        </header>

        <section class="p-4 grid grid-cols-3 gap-2">
            <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm text-center">
                <p id="m2-name" class="text-[9px] font-bold text-slate-400 uppercase">--</p>
                <h3 id="m2-total" class="text-sm font-black text-slate-700">0</h3>
            </div>
            <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm text-center border-b-4 border-b-blue-200">
                <p id="m1-name" class="text-[9px] font-bold text-slate-400 uppercase">--</p>
                <h3 id="m1-total" class="text-sm font-black text-slate-700">0</h3>
            </div>
            <div class="bg-blue-600 p-3 rounded-2xl shadow-md text-center text-white">
                <p class="text-[9px] font-bold uppercase opacity-80">This Month</p>
                <h3 id="curr-total" class="text-sm font-black">0</h3>
            </div>
        </section>

        <section class="px-4 mb-4">
            <div class="bg-white p-4 rounded-3xl border border-slate-200 shadow-sm text-center">
                <p id="filter-status" class="text-[10px] font-bold text-blue-500 uppercase mb-2 hidden">Filtering by Category</p>
                <div class="max-w-[160px] mx-auto">
                    <canvas id="expenseChart"></canvas>
                </div>
                <p class="text-[9px] text-slate-400 mt-2 italic">Click a slice to filter list</p>
            </div>
        </section>

        <section class="px-4 pb-4">
            <div class="bg-white rounded-2xl border p-5 shadow-sm">
                <form id="expense-form" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3 relative">
                        <div class="relative col-span-1">
                            <input type="text" id="cat-search" placeholder="Search Category..." 
                                class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none border border-transparent focus:border-blue-300" autocomplete="off">
                            <div id="cat-list" class="hidden absolute top-full left-0 w-full bg-white border shadow-xl rounded-xl mt-1 z-50 max-h-48 overflow-y-auto p-1"></div>
                            <input type="hidden" id="selected-category" required>
                        </div>
                        <input type="date" id="exp-date" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3">
                        <input type="number" step="0.01" id="amount" placeholder="0.00" class="col-span-1 bg-slate-50 rounded-xl p-3 text-sm" required>
                        <input type="text" id="desc" placeholder="Description" class="col-span-2 bg-slate-50 rounded-xl p-3 text-sm" required>
                    </div>
                    <button type="submit" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-black transition-all">Add Expense</button>
                </form>
            </div>
        </section>

        <section id="expense-list" class="px-4 space-y-3"></section>
    </div>

    <script>
        let db;
        let myChart = null;
        let activeFilter = null;
        const DB_NAME = "ExpanseTracDB";
        const STORE_NAME = "expenses";

        // --- Database Initialization ---
        const request = indexedDB.open(DB_NAME, 1);

        request.onupgradeneeded = (e) => {
            db = e.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: "id", autoIncrement: true });
            }
        };

        request.onsuccess = (e) => {
            db = e.target.result;
            initChart();
            loadFromDB();
        };

        const categories = [
            "üõí Grocery", "üè• Medical", "üõçÔ∏è Shopping", "üçΩÔ∏è Food & Drink", 
            "üíß Water", "üî• Gas", "üöå Transportation", "üè† Rent", 
            "üì± Phone & Internet", "üëï Cloths", "üé¨ Entertainment", "üéÅ Nevta", "üì¶ Other"
        ];

        // --- Category Logic ---
        const catSearch = document.getElementById('cat-search');
        const catList = document.getElementById('cat-list');
        const hiddenCat = document.getElementById('selected-category');

        function renderCategories(filter = "") {
            const filtered = categories.filter(c => c.toLowerCase().includes(filter.toLowerCase()));
            catList.innerHTML = filtered.map(c => 
                `<div class="p-3 hover:bg-blue-50 cursor-pointer rounded-lg text-sm font-medium" onclick="selectCategory('${c}')">${c}</div>`
            ).join('');
        }

        catSearch.onfocus = () => { renderCategories(); catList.classList.remove('hidden'); };
        catSearch.oninput = (e) => renderCategories(e.target.value);
        
        window.selectCategory = (val) => {
            catSearch.value = val;
            hiddenCat.value = val;
            catList.classList.add('hidden');
        };

        // --- Chart & Filter ---
        function initChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'], borderWidth: 0 }] },
                options: { 
                    cutout: '75%', 
                    plugins: { legend: { display: false } },
                    onClick: (e, active) => {
                        if (active.length > 0) {
                            const idx = active[0].index;
                            filterListByCategory(myChart.data.labels[idx]);
                        } else {
                            filterListByCategory(null);
                        }
                    }
                }
            });
        }

        function filterListByCategory(category) {
            const statusLabel = document.getElementById('filter-status');
            if (activeFilter === category) {
                activeFilter = null;
                statusLabel.classList.add('hidden');
            } else {
                activeFilter = category;
                statusLabel.innerText = `Showing: ${category}`;
                statusLabel.classList.remove('hidden');
            }
            loadFromDB();
        }

        // --- Data Operations ---
        function loadFromDB() {
            const transaction = db.transaction([STORE_NAME], "readonly");
            const store = transaction.objectStore(STORE_NAME);
            const getAll = store.getAll();

            getAll.onsuccess = () => {
                updateUI(getAll.result);
            };
        }

        function updateUI(data) {
            let totals = { lifetime: 0, current: 0, last1: 0, last2: 0 };
            let catTotals = {};
            let html = '';
            const now = new Date();

            const d1 = new Date(); d1.setMonth(now.getMonth() - 1);
            const d2 = new Date(); d2.setMonth(now.getMonth() - 2);
            document.getElementById('m1-name').innerText = d1.toLocaleString('default', { month: 'short' });
            document.getElementById('m2-name').innerText = d2.toLocaleString('default', { month: 'short' });

            // Sort data: Newest date first
            data.sort((a, b) => new Date(b.date) - new Date(a.date));

            data.forEach((item) => {
                const amount = parseFloat(item.amount) || 0;
                const date = new Date(item.date);
                
                totals.lifetime += amount;
                
                if (date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear()) {
                    totals.current += amount;
                    catTotals[item.category] = (catTotals[item.category] || 0) + amount;
                } else if (date.getMonth() === d1.getMonth() && date.getFullYear() === d1.getFullYear()) {
                    totals.last1 += amount;
                } else if (date.getMonth() === d2.getMonth() && date.getFullYear() === d2.getFullYear()) {
                    totals.last2 += amount;
                }

                if (!activeFilter || item.category === activeFilter) {
                    html += `
                        <div class="bg-white p-4 rounded-2xl flex justify-between items-center shadow-sm border border-slate-100">
                            <div class="flex items-center gap-3">
                                <div class="bg-slate-100 text-[9px] font-bold p-2 rounded-lg text-slate-500 text-center uppercase">
                                    ${date.toLocaleDateString('en-GB', {day:'2-digit', month:'short'}).replace(' ', '<br>')}
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-slate-800">${item.description}</p>
                                    <p class="text-[10px] text-slate-400 uppercase tracking-tighter">${item.category}</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="font-black text-slate-900">${amount.toFixed(2)}</span>
                                <button onclick="deleteItem(${item.id})" class="text-slate-200 hover:text-red-500">‚úï</button>
                            </div>
                        </div>`;
                }
            });

            document.getElementById('expense-list').innerHTML = html || '<p class="text-center text-slate-400 py-10 text-sm">No expenses found.</p>';
            document.getElementById('total-amount').innerText = totals.lifetime.toFixed(2);
            document.getElementById('curr-total').innerText = Math.round(totals.current);
            document.getElementById('m1-total').innerText = Math.round(totals.last1);
            document.getElementById('m2-total').innerText = Math.round(totals.last2);

            myChart.data.labels = Object.keys(catTotals);
            myChart.data.datasets[0].data = Object.values(catTotals);
            myChart.update();
        }

        document.getElementById('expense-form').onsubmit = (e) => {
            e.preventDefault();
            if(!hiddenCat.value) return alert("Select a Category");
            
            const newExp = {
                category: hiddenCat.value,
                description: document.getElementById('desc').value,
                amount: parseFloat(document.getElementById('amount').value),
                date: document.getElementById('exp-date').value // Store as YYYY-MM-DD
            };

            const transaction = db.transaction([STORE_NAME], "readwrite");
            const store = transaction.objectStore(STORE_NAME);
            store.add(newExp);

            transaction.oncomplete = () => {
                e.target.reset();
                catSearch.value = ""; hiddenCat.value = "";
                document.getElementById('exp-date').valueAsDate = new Date();
                loadFromDB();
            };
        };

        window.deleteItem = (id) => { 
            if(confirm("Delete this expense?")) {
                const transaction = db.transaction([STORE_NAME], "readwrite");
                const store = transaction.objectStore(STORE_NAME);
                store.delete(id);
                transaction.oncomplete = () => loadFromDB();
            }
        };

        window.onload = () => {
            document.getElementById('exp-date').valueAsDate = new Date();
        };
    </script>
</body>
</html>