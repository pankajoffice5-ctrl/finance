<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Work Log | Full PDF Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

    <div id="login-screen" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-6 text-center">
        <h1 class="text-3xl font-black text-blue-600 mb-2">Work Log</h1>
        <p class="text-slate-500 mb-8">Sign in to manage your records</p>
        <button onclick="signInWithGoogle()" class="flex items-center gap-3 bg-white border border-slate-300 px-6 py-3 rounded-xl font-bold shadow-sm hover:bg-slate-50 transition-all">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/0/google.svg" width="20">
            Sign in with Google
        </button>
    </div>

    <div id="app-content" class="max-w-md mx-auto pb-24 hidden">
        
        <nav class="flex justify-between items-center p-6">
            <a href="#" class="text-xs font-bold text-slate-500 tracking-widest uppercase">üè† Home</a>
            <button onclick="signOut()" class="text-[10px] text-red-500 font-bold uppercase">Logout</button>
        </nav>

        <div id="pdf-area">
            <header class="px-4 mb-4">
                <h1 class="text-xl font-black text-blue-600 mb-4">Attendance Report</h1>
                <section class="grid grid-cols-3 gap-2">
                    <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm text-center">
                        <p id="m2-name" class="text-[9px] font-bold text-slate-400 uppercase mb-1">--</p>
                        <div class="text-[10px] font-bold text-slate-700">
                            <span id="m2-p">0</span>P | <span id="m2-ot">0</span>OT
                        </div>
                    </div>
                    <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm text-center">
                        <p id="m1-name" class="text-[9px] font-bold text-slate-400 uppercase mb-1">--</p>
                        <div class="text-[10px] font-bold text-slate-700">
                            <span id="m1-p">0</span>P | <span id="m1-ot">0</span>OT
                        </div>
                    </div>
                    <div class="bg-blue-600 p-3 rounded-2xl shadow-md text-center text-white">
                        <p class="text-[9px] font-bold uppercase opacity-80 mb-1">Current</p>
                        <div class="text-[10px] font-black">
                            <span id="cur-p">0</span>P | <span id="cur-ot">0</span>OT
                        </div>
                    </div>
                </section>
            </header>

            <section class="px-4 mb-6">
                <div class="bg-white rounded-2xl border border-slate-200 p-5 shadow-sm">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="text-xs font-black text-slate-800 uppercase">Monthly Salary Analysis</h3>
                        <p id="slip-month" class="text-[9px] text-slate-400 font-bold"></p>
                    </div>

                    <div class="mb-4 no-print">
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Base Salary (8hr/Day)</label>
                        <input type="number" id="basic-salary" onkeyup="calculateSalary()" class="w-full text-lg font-black text-slate-800 border-b outline-none py-1 bg-transparent" placeholder="0.00">
                    </div>

                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-slate-500">Regular Pay:</span>
                            <span id="calc-base" class="font-bold text-slate-800">0.00</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-slate-500">OT Pay:</span>
                            <span id="calc-ot" class="font-bold text-green-600">0.00</span>
                        </div>
                        <div class="border-t pt-2 flex justify-between">
                            <span class="font-bold text-blue-600">Total Est. Salary:</span>
                            <span id="calc-total" class="font-black text-blue-600">0.00</span>
                        </div>
                    </div>
                </div>
            </section>

            <section class="px-4 space-y-3">
                <h3 class="text-[10px] font-bold text-slate-400 uppercase ml-1">Daily Logs</h3>
                <div id="attendance-list" class="space-y-2"></div>
            </section>
        </div>

        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/80 backdrop-blur-md border-t border-slate-100 max-w-md mx-auto">
            <div class="flex gap-2">
                <button onclick="toggleForm()" class="flex-1 bg-slate-900 text-white font-bold py-3 rounded-xl">Add Entry</button>
                <button onclick="downloadFullPDF()" class="bg-blue-600 text-white px-4 py-3 rounded-xl shadow-lg">
                    üì• PDF
                </button>
            </div>
        </div>

        <div id="entry-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-6">
            <div class="bg-white w-full rounded-3xl p-6">
                <form id="attendance-form" class="space-y-4">
                    <input type="date" id="att-date" class="w-full bg-slate-50 rounded-xl p-3 border" required>
                    <select id="status" class="w-full bg-slate-50 rounded-xl p-3 border">
                        <option value="Present">‚úÖ Present</option>
                        <option value="Absent">‚ùå Absent</option>
                        <option value="Late">‚è∞ Late</option>
                    </select>
                    <div id="ot-container" class="bg-blue-50 p-4 rounded-xl flex justify-between items-center">
                        <label class="text-xs font-bold text-blue-700 uppercase">Overtime (Hrs)</label>
                        <input type="number" id="ot-hours" step="0.5" value="0" class="w-20 rounded-lg p-2 font-bold text-center">
                    </div>
                    <div class="flex gap-2">
                        <button type="button" onclick="toggleForm()" class="flex-1 bg-slate-100 py-3 rounded-xl font-bold">Cancel</button>
                        <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-xl font-bold">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyCY-uSI1r3BxARYwGTvhTh2hYgAI-3yBeQ",
            authDomain: "attendance-83fa2.firebaseapp.com",
            projectId: "attendance-83fa2",
            storageBucket: "attendance-83fa2.firebasestorage.app",
            messagingSenderId: "877237859008",
            appId: "1:877237859008:web:904ae7f4eea6823babb325"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;
        let globalStats = { curP: 0, curOT: 0 };

        // --- Auth ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                const saved = localStorage.getItem('basicSalary');
                if(saved) document.getElementById('basic-salary').value = saved;
                loadLogs();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        });

        function signInWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function signOut() { auth.signOut(); }
        function toggleForm() { document.getElementById('entry-modal').classList.toggle('hidden'); document.getElementById('entry-modal').classList.toggle('flex'); }

        // --- Data ---
        function loadLogs() {
            db.collection("users").doc(currentUser.uid).collection("logs").orderBy("date", "desc")
              .onSnapshot(snap => {
                  const logs = [];
                  snap.forEach(doc => logs.push(doc.data()));
                  renderData(logs);
              });
        }

        function renderData(data) {
            let html = '';
            let stats = { curP: 0, curOT: 0, m1P: 0, m1OT: 0, m2P: 0, m2OT: 0 };
            const now = new Date();
            const d1 = new Date(); d1.setMonth(now.getMonth() - 1);
            const d2 = new Date(); d2.setMonth(now.getMonth() - 2);

            data.forEach(entry => {
                const date = new Date(entry.date);
                const ot = parseFloat(entry.otHours) || 0;
                const isP = entry.status === 'Present';

                if (date.getMonth() === now.getMonth()) { if(isP) stats.curP++; stats.curOT += ot; }
                else if (date.getMonth() === d1.getMonth()) { if(isP) stats.m1P++; stats.m1OT += ot; }
                else if (date.getMonth() === d2.getMonth()) { if(isP) stats.m2P++; stats.m2OT += ot; }

                html += `
                <div class="bg-white p-3 rounded-xl flex justify-between items-center border border-slate-100">
                    <div class="flex items-center gap-3">
                        <div class="text-[9px] font-bold text-slate-400 uppercase">${date.toLocaleDateString('en-GB', {day:'2-digit', month:'short'})}</div>
                        <div class="text-sm font-bold ${isP ? 'text-green-600' : 'text-red-400'}">${entry.status} ${ot > 0 ? '(OT: '+ot+')' : ''}</div>
                    </div>
                    <button onclick="deleteAtt('${entry.date}')" class="text-slate-300 hover:text-red-500 no-print">‚úï</button>
                </div>`;
            });

            document.getElementById('attendance-list').innerHTML = html;
            document.getElementById('cur-p').innerText = stats.curP;
            document.getElementById('cur-ot').innerText = stats.curOT;
            document.getElementById('m1-p').innerText = stats.m1P; document.getElementById('m1-ot').innerText = stats.m1OT;
            document.getElementById('m2-p').innerText = stats.m2P; document.getElementById('m2-ot').innerText = stats.m2OT;
            document.getElementById('m1-name').innerText = d1.toLocaleString('default', { month: 'short' });
            document.getElementById('m2-name').innerText = d2.toLocaleString('default', { month: 'short' });
            document.getElementById('slip-month').innerText = now.toLocaleString('default', { month: 'long', year:'numeric' });
            globalStats = stats;
            calculateSalary();
        }

        async function deleteAtt(id) { if(confirm("Delete?")) await db.collection("users").doc(currentUser.uid).collection("logs").doc(id).delete(); }

        // --- Calculator ---
        function calculateSalary() {
            const basic = parseFloat(document.getElementById('basic-salary').value) || 0;
            localStorage.setItem('basicSalary', basic);
            const daily = basic / 30;
            const hourly = daily / 8;
            const basePay = globalStats.curP * daily;
            const otPay = globalStats.curOT * hourly;
            document.getElementById('calc-base').innerText = basePay.toFixed(2);
            document.getElementById('calc-ot').innerText = otPay.toFixed(2);
            document.getElementById('calc-total').innerText = (basePay + otPay).toFixed(2);
        }

        // --- Full Page PDF Download ---
        function downloadFullPDF() {
            const element = document.getElementById('pdf-area');
            const opt = {
                margin:       [15, 10, 15, 10], // top, left, bottom, right
                filename:     'Work_Report_' + new Date().toISOString().slice(0,10) + '.pdf',
                image:        { type: 'jpeg', quality: 1 },
                html2canvas:  { scale: 3, useCORS: true, logging: false },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            // Generate PDF
            html2pdf().set(opt).from(element).save();
        }

        document.getElementById('attendance-form').onsubmit = async (e) => {
            e.preventDefault();
            const date = document.getElementById('att-date').value;
            await db.collection("users").doc(currentUser.uid).collection("logs").doc(date).set({
                date: date,
                status: document.getElementById('status').value,
                otHours: document.getElementById('status').value === 'Present' ? parseFloat(document.getElementById('ot-hours').value) : 0
            });
            toggleForm();
        };

        window.onload = () => document.getElementById('att-date').valueAsDate = new Date();
    </script>

    <style>
        /* This ensures UI elements like the delete X or input boxes don't look messy in PDF */
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</body>
</html>
